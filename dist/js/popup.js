function split(a){return a.split(/ \s*/)}function extractLast(a){return split(a).pop()}function serializeArray(a){var b=[];return a=a||{},Object.keys(a).forEach(function(c){b.push(c+"="+a[c])}),b}if("?foo"!==location.search)throw location.search="?foo",new Error;var pinput={};pinput.authToken="",pinput.StorageKey={APIToken:"pinput_APIToken",isAuthenticated:"pinput_isAuthenticated"},pinput.Message={isBookmarked:"This URL is already bookmarked.",isNotAuthenticated:"API Token is not authenticated.",succeed:"Bookmarked successfully!",failed:"Bookmark is failed..."},pinput.API={addPost:function(a,b,c,d){var e=serializeArray({format:"json",auth_token:pinput.authToken,url:encodeURIComponent(a),description:encodeURIComponent(b),extended:encodeURIComponent(c),tags:encodeURIComponent(d),shared:$private.prop("checked")?"no":"yes",toread:$readlater.prop("checked")?"yes":"no",_:Date.now()});return"https://api.pinboard.in/v1/posts/add?"+e.join("&")},getPost:function(a){var b=serializeArray({format:"json",auth_token:pinput.authToken,url:encodeURIComponent(a),_:Date.now()});return"https://api.pinboard.in/v1/posts/get?"+b.join("&")},suggestPost:function(a){var b=serializeArray({format:"json",auth_token:pinput.authToken,url:encodeURIComponent(a),_:Date.now()});return"https://api.pinboard.in/v1/posts/suggest?"+b.join("&")},getTags:function(){var a=serializeArray({format:"json",auth_token:pinput.authToken,_:Date.now()});return"https://api.pinboard.in/v1/tags/get?"+a.join("&")}},$(function(){var a=$("#js-form"),b=$("#js-url"),c=$("#js-title"),d=$("#js-tags"),e=$("#js-description"),f=$("#js-private"),g=$("#js-readlater"),h=$("#js-bookmark"),i=$("#js-alert"),j=chrome.storage.sync;chrome.runtime.sendMessage({},function(k){b.val(k.url),c.val(k.title),d.focus(),j.get([pinput.StorageKey.APIToken,pinput.StorageKey.isAuthenticated],function(j){pinput.authToken=j[pinput.StorageKey.APIToken],j[pinput.StorageKey.isAuthenticated]?($.getJSON(pinput.API.getPost(k.url)).done(function(a){0!==a.posts.length?(d.val(a.posts.shift().tags),i.removeClass("alert-info alert-success alert-danger"),i.html(pinput.Message.isBookmarked).addClass("alert-warning")):$.getJSON(pinput.API.suggestPost(k.url)).done(function(a){a.forEach(function(a){Array.isArray(a.popular)&&d.val(a.popular.join(" "))})})}).always(function(){$.getJSON(pinput.API.getTags()).done(function(a){var b=Object.keys(a);d.bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&a.preventDefault()}).autocomplete({minLength:0,max:5,autoFocus:!0,source:function(a,c){c($.ui.autocomplete.filter(b,extractLast(a.term)).slice(0,5))},focus:function(){return!1},select:function(a,b){var c=split(this.value);return c.pop(),c.push(b.item.value),c.push(""),this.value=c.join(" "),!1}})})}),a.on("submit",function(a){a.preventDefault();var h=pinput.API.addPost({url:b.val(),description:c.val(),extended:e.val(),tags:d.val(),shared:f.prop("checked")?"no":"yes",toread:g.prop("checked")?"yes":"no"});$.getJSON(h).done(function(a){"done"!==a.result_code?(i.removeClass("alert-info alert-warning alert-success"),i.html(a.result_code).addClass("alert-danger")):(i.removeClass("alert-info alert-warning alert-danger"),i.html(pinput.Message.succeed).addClass("alert-success"),window.setTimeout(function(){window.close()},500))}).fail(function(a){i.removeClass("alert-info alert-warning alert-success"),i.html(a).addClass("alert-danger")})}),h.on("click",function(a){a.preventDefault();var h=pinput.API.addPost({url:b.val(),description:c.val(),extended:e.val(),tags:d.val(),shared:f.prop("checked")?"no":"yes",toread:g.prop("checked")?"yes":"no"});$.getJSON(h).done(function(a){"done"!==a.result_code?(i.removeClass("alert-info alert-warning alert-success"),i.html(a.result_code).addClass("alert-danger")):(i.removeClass("alert-info alert-warning alert-danger"),i.html(pinput.Message.succeed).addClass("alert-success"),window.setTimeout(function(){window.close()},500))}).fail(function(a){i.removeClass("alert-info alert-warning alert-success"),i.html(a).addClass("alert-danger")})})):(i.removeClass("alert-info alert-warning alert-success"),i.html(pinput.Message.isNotAuthenticated).addClass("alert-danger"),h.attr("disabled","disabled"))})})});