if("?foo"!==location.search)throw location.search="?foo",new Error;$(function(){function a(a){return a.split(/ \s*/)}function b(b){return a(b).pop()}function c(a){var b=[];return a=a||{},Object.keys(a).forEach(function(c){b.push(c+"="+a[c])}),b}function d(){var a=c({format:"json",auth_token:e,url:encodeURIComponent(g.val()),description:encodeURIComponent(h.val()),extended:encodeURIComponent(j.val()),tags:encodeURIComponent(i.val()),shared:k.prop("checked")?"no":"yes",toread:l.prop("checked")?"yes":"no",_:Date.now()}),b=$.getJSON("https://api.pinboard.in/v1/posts/add?"+a.join("&"));b.done(function(a){"done"!==a.result_code?(n.removeClass("alert-info alert-warning alert-success"),n.html(a.result_code).addClass("alert-danger")):(n.removeClass("alert-info alert-warning alert-danger"),n.html(q.succeed).addClass("alert-success"),window.setTimeout(function(){window.close()},500))}).fail(function(a){n.removeClass("alert-info alert-warning alert-success"),n.html(a).addClass("alert-danger")})}var e="",f=$("#js-form"),g=$("#js-url"),h=$("#js-title"),i=$("#js-tags"),j=$("#js-description"),k=$("#js-private"),l=$("#js-readlater"),m=$("#js-bookmark"),n=$("#js-alert"),o=chrome.storage.sync,p={APIToken:"pinput_APIToken",isAuthenticated:"pinput_isAuthenticated"},q={isBookmarked:"This URL is already bookmarked.",isNotAuthenticated:"API Token is not authenticated.",succeed:"Bookmarked successfully!",failed:"Bookmark is failed..."};chrome.runtime.sendMessage({},function(j){g.val(j.url),h.val(j.title),i.focus(),o.get([p.APIToken,p.isAuthenticated],function(g){if(e=g[p.APIToken],g[p.isAuthenticated]){var h=c({format:"json",auth_token:e,url:j.url,_:Date.now()}),k=$.getJSON("https://api.pinboard.in/v1/posts/get?"+h.join("&"));k.done(function(a){if(0!==a.posts.length)i.val(a.posts.shift().tags),n.removeClass("alert-info alert-success alert-danger"),n.html(q.isBookmarked).addClass("alert-warning");else{var b=$.getJSON("https://api.pinboard.in/v1/posts/suggest?"+h.join("&"));b.done(function(a){a.forEach(function(a){Array.isArray(a.popular)&&i.val(a.popular.join(" "))})})}}).always(function(){$.getJSON("https://api.pinboard.in/v1/tags/get?format=json&auth_token="+e).done(function(c){var d=Object.keys(c);i.bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&a.preventDefault()}).autocomplete({minLength:0,max:5,autoFocus:!0,source:function(a,c){c($.ui.autocomplete.filter(d,b(a.term)).slice(0,5))},focus:function(){return!1},select:function(b,c){var d=a(this.value);return d.pop(),d.push(c.item.value),d.push(""),this.value=d.join(" "),!1}})})}),f.on("submit",function(a){a.preventDefault(),d()}),m.on("click",function(a){a.preventDefault(),d()})}else n.removeClass("alert-info alert-warning alert-success"),n.html(q.isNotAuthenticated).addClass("alert-danger"),m.attr("disabled","disabled")})})});