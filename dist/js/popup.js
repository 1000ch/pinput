function split(a){return a.split(/ \s*/)}function extractLast(a){return split(a).pop()}function serializeArray(a){var b=[];return a=a||{},Object.keys(a).forEach(function(c){b.push(c+"="+a[c])}),b}if("?foo"!==location.search)throw location.search="?foo",new Error;var pinput={};pinput.StorageKey={APIToken:"pinput_APIToken",isAuthenticated:"pinput_isAuthenticated"},pinput.Message={isBookmarked:"This URL is already bookmarked.",isNotAuthenticated:"API Token is not authenticated.",succeed:"Bookmarked successfully!",failed:"Bookmark is failed..."},pinput.API={addPost:function(a,b,c,d){var e=serializeArray({format:"json",auth_token:token,url:encodeURIComponent(a),description:encodeURIComponent(b),extended:encodeURIComponent(c),tags:encodeURIComponent(d),shared:$private.prop("checked")?"no":"yes",toread:$readlater.prop("checked")?"yes":"no",_:Date.now()});return"https://api.pinboard.in/v1/posts/add?"+e.join("&")},getPost:function(a){var b=serializeArray({format:"json",auth_token:token,url:encodeURIComponent(a),_:Date.now()});return"https://api.pinboard.in/v1/posts/get?"+b.join("&")},suggestPost:function(a){var b=serializeArray({format:"json",auth_token:token,url:encodeURIComponent(a),_:Date.now()});return"https://api.pinboard.in/v1/posts/suggest?"+b.join("&")},getTags:function(){var a=serializeArray({format:"json",auth_token:token,_:Date.now()});return"https://api.pinboard.in/v1/tags/get?"+a.join("&")}},$(function(){var a="",b=$("#js-form"),c=$("#js-url"),d=$("#js-title"),e=$("#js-tags"),f=$("#js-description"),g=$("#js-private"),h=$("#js-readlater"),i=$("#js-bookmark"),j=$("#js-alert"),k=chrome.storage.sync;chrome.runtime.sendMessage({},function(l){c.val(l.url),d.val(l.title),e.focus(),k.get([pinput.StorageKey.APIToken,pinput.StorageKey.isAuthenticated],function(k){a=k[pinput.StorageKey.APIToken],k[pinput.StorageKey.isAuthenticated]?($.getJSON(pinput.API.getPost(l.url)).done(function(a){0!==a.posts.length?(e.val(a.posts.shift().tags),j.removeClass("alert-info alert-success alert-danger"),j.html(pinput.Message.isBookmarked).addClass("alert-warning")):$.getJSON(pinput.API.suggestPost(l.url)).done(function(a){a.forEach(function(a){Array.isArray(a.popular)&&e.val(a.popular.join(" "))})})}).always(function(){$.getJSON(pinput.API.getTags()).done(function(a){var b=Object.keys(a);e.bind("keydown",function(a){a.keyCode===$.ui.keyCode.TAB&&$(this).data("ui-autocomplete").menu.active&&a.preventDefault()}).autocomplete({minLength:0,max:5,autoFocus:!0,source:function(a,c){c($.ui.autocomplete.filter(b,extractLast(a.term)).slice(0,5))},focus:function(){return!1},select:function(a,b){var c=split(this.value);return c.pop(),c.push(b.item.value),c.push(""),this.value=c.join(" "),!1}})})}),b.on("submit",function(a){a.preventDefault();var b=pinput.API.addPost({url:c.val(),description:d.val(),extended:f.val(),tags:e.val(),shared:g.prop("checked")?"no":"yes",toread:h.prop("checked")?"yes":"no"});$.getJSON(b).done(function(a){"done"!==a.result_code?(j.removeClass("alert-info alert-warning alert-success"),j.html(a.result_code).addClass("alert-danger")):(j.removeClass("alert-info alert-warning alert-danger"),j.html(pinput.Message.succeed).addClass("alert-success"),window.setTimeout(function(){window.close()},500))}).fail(function(a){j.removeClass("alert-info alert-warning alert-success"),j.html(a).addClass("alert-danger")})}),i.on("click",function(a){a.preventDefault();var b=pinput.API.addPost({url:c.val(),description:d.val(),extended:f.val(),tags:e.val(),shared:g.prop("checked")?"no":"yes",toread:h.prop("checked")?"yes":"no"});$.getJSON(b).done(function(a){"done"!==a.result_code?(j.removeClass("alert-info alert-warning alert-success"),j.html(a.result_code).addClass("alert-danger")):(j.removeClass("alert-info alert-warning alert-danger"),j.html(pinput.Message.succeed).addClass("alert-success"),window.setTimeout(function(){window.close()},500))}).fail(function(a){j.removeClass("alert-info alert-warning alert-success"),j.html(a).addClass("alert-danger")})})):(j.removeClass("alert-info alert-warning alert-success"),j.html(pinput.Message.isNotAuthenticated).addClass("alert-danger"),i.attr("disabled","disabled"))})})});